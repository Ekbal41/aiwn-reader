<!DOCTYPE html>
<html lang="en">
    <head>
        <title>AIWN Reader</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
/>
        <style>
            .chapter-url {
                text-decoration: underline;
                color: #007bff;
            }
        </style>
    </head>
    <body class="d-flex flex-column min-vh-100" data-bs-theme="dark">

        <!-- Main Content -->
        <main class="container my-5 pt-5 flex-grow-1">
            {% if error %}
                <div class="alert alert-danger text-center">{{ error }}</div>
            {% endif %}
            <div class="form-container mx-auto" style="max-width: 500px;">
                <form id="translateForm" action="/translate" method="POST">
                    <div class="mb-3">
                        <input
              type="url"
              name="url"
              id="url"
              class="form-control"
              placeholder="Enter chapter URL (e.g., https://example.com)"
              required
/>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Translate</button>
                        <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-toggle="offcanvas"
              data-bs-target="#chapterOffcanvas"
            >
              View Saved Chapters
            </button>
                    </div>
                </form>
            </div>
        </main>

        <!-- Offcanvas for Saved Chapters -->
        <div
      class="offcanvas offcanvas-start"
      tabindex="-1"
      id="chapterOffcanvas"
      aria-labelledby="chapterOffcanvasLabel"
    >
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="chapterOffcanvasLabel">
          Saved Chapters <span class="badge badge-sm text-bg-primary" id="scbadge">0</span>

                </h5>
                <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
            </div>
            <div class="offcanvas-body">
                <ul class="list-group" id="chapterList"></ul>
                <button
          class="btn btn-outline-danger mt-3 w-100"
          onclick="clearChapters()"
        >
          Clear All Chapters
        </button>
            </div>
        </div>
        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function loadChapters() {
                const chapterList = document.getElementById("chapterList");
                chapterList.innerHTML = "";
                const scbadge = document.getElementById("scbadge");
                scbadge.innerHTML = localStorage.length
                for (let i = 0; i < localStorage.length; i++) {
                    const url = localStorage.key(i);
                    try {
                        const chapter = JSON.parse(localStorage.getItem(url));
                        if (chapter && chapter.translated && chapter.title) {
                            const truncatedUrl = url.slice(0, 15) + (
                                url.length > 15
                                ? '...'
                                : '');
                            const li = document.createElement("li");
                            li.className = "list-group-item chapter-item";
                            li.innerHTML = `
                <div class="d-flex justify-content-between align-items-end"><div class="chapter-info">
                   <strong>${chapter
                                .title}...</strong><br>
                  <small class="chapter-url" data-bs-toggle="popover" data-bs-content="${url}" data-bs-trigger="hover">${truncatedUrl}</small><br>
                  <small>${new Date(chapter.timestamp)
                                .toLocaleString()}</small>
                </div>
                <button class="btn btn-sm btn-danger mb-1" onclick="deleteChapter('${url}')">Delete</button></div>
              `;
                            li
                                .querySelector(".chapter-info")
                                .onclick = () => {
                                    const form = document.createElement("form");
                                    form.method = "POST";
                                    form.action = "/translate";
                                    const input = document.createElement("input");
                                    input.type = "hidden";
                                    input.name = "storedChapter";
                                    input.value = JSON.stringify(chapter);
                                    form.appendChild(input);
                                    document
                                        .body
                                        .appendChild(form);
                                    form.submit();
                                };
                            chapterList.appendChild(li);
                        }
                    } catch (e) {
                        console.error("Error parsing chapter:", url, e);
                    }
                }
                const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
                const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
            }

            function deleteChapter(url) {
                localStorage.removeItem(url);
                loadChapters();
            }

            function clearChapters() {
                localStorage.clear();
                loadChapters();
            }

            document
                .getElementById("translateForm")
                .addEventListener("submit", (e) => {
                    const url = document
                        .getElementById("url")
                        .value;
                    const storedChapter = localStorage.getItem(url);
                    if (storedChapter) {
                        e.preventDefault();
                        const form = document.createElement("form");
                        form.method = "POST";
                        form.action = "/translate";
                        const input = document.createElement("input");
                        input.type = "hidden";
                        input.name = "storedChapter";
                        input.value = storedChapter;
                        form.appendChild(input);
                        document
                            .body
                            .appendChild(form);
                        form.submit();
                    }
                });

            window.onload = loadChapters;
        </script>
    </body>
</html>